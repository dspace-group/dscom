# dscom.build

## Project

Within the [source](../../src/) folder, a project called [dscom.build](../../src/dscom.build/) was created. It consumes the core tasks package of MsBuild and the dSPACE.Runtime.InteropServices assembly. The resulting assembly will be called `dSPACE.Runtime.InteropServices.Build`. This will also be the name of the NuGet package.

The Nug

The project consists of two notable classes.

### Class `TlbExport`

The class [`dSPACE.Runtime.InteropServices.Build.TlbExport`](../../src/dscom.build/TlbExport.cs) contains the implementation of the build task.

It consumes the following properties:

* `TlbOverriddenId`: The id of the type library. If it is set to the empty Guid, the Guid of the TypeLibrary will be used.
* `TargetFile` (Required): The full path to the type library to export.
* `SourceAssemblyFile` (Required): The full path of the managed assembly to export.
* `TypeLibraryReferences`: The input type libraries to reference during export.
* `TypeLibraryReferencePaths`: A list of paths containing type library files to reference automatically during export.
* `AssemblyPaths`: The references of the source assembly which must be loaded for export.

It contains the method `bool Execute()` as an implementation of the `ITask` interface.

The execute method will load the `dSPACE.Runtime.InteropServices.dll`. It tries to locate the file next to the build task assembly and - if cannot be present at that time - let the .NET runtime try to resolve it.

During the execution phase, the following steps will be made:

* Parse the overridden type library Guid.
* Fail execution, if the build is not executed on windows.
* Convert the `ITaskItems` (cf. `TypeLibraryReferences`, `TypeLibraryReferencePaths`, `AssemblyPaths`) to file system identifiers. If a file or directory is not present, a warning will be issued using the MsBuild `TaskLoggingHelper`. The export will continue.
* Resolve the `SourceAssemblyFile` and issue an error, if it was not found.
* Convert the assembly using the `DefaultBuildContext`.

The `DefaultBuildContext` represents a level of abstraction. It contains the part of the implementation that cannot be stubbed or mocked at run-time.

The execution will be successful, if the build context returns success and the task logging helper did not log any errors.

### Class `DefaultBuildContext`

The `DefaultBuildContext` is an implementation of the [`IBuildContext`](../../src/dscom.build/IBuildContext.cs) interface. It provides the following operations:

* Check, whether the build is running on windows.
* Check, whether given files and directories exist.
* Perform the export using the `TypeLibConverterSettings`.

The export is done using the `TypeLibConverter` instance and an implementation of the [`ITypeLibExporterNotifySink`](../../src/dscom.build/LoggingTypeLibExporterSink.cs), which logs the events to the build log.

If the type library converter did not report a successful export, an error will be issued. If the expected file did not exists after the export, a warning shall be issued.

It is an issue for discussion, if this check can be added to the `TlbExport` implementation. This way, the warning can be unit tested.

### Build sequence (TlbExport)

```ditaa
                    ┌───────────┐                       ┌─────────┐                                                                     ┌─────────────┐                                                                                                         ┌─────────────────┐          ┌────────┐                                                                            ┌───┐                    
                    │BuildEngine│                       │TlbExport│                                                                     │IBuildContext│                                                                                                         │AppDomain.Current│          │Assembly│                                                                            │Log│                    
                    └─────┬─────┘                       └────┬────┘                                                                     └──────┬──────┘                                                                                                         └────────┬────────┘          └───┬────┘                                                                            └─┬─┘                    
                          │            Execute              ┌┴┐                                                                                │                                                                                                                         │                       │                                                                                   │                      
                          │────────────────────────────────>│ │                                                                                │                                                                                                                         │                       │                                                                                   │                      
                          │                                 │ │                                                                                │                                                                                                                         │                       │                                                                                   │                      
                          │                                 │ │                              IsRunningOnWindows()                              │                                                                                                                         │                       │                                                                                   │                      
                          │                                 │ │ ──────────────────────────────────────────────────────────────────────────────>│                                                                                                                         │                       │                                                                                   │                      
                          │                                 │ │                                                                                │                                                                                                                         │                       │                                                                                   │                      
                          │                                 │ │                                                                                │                                                                                                                         │                       │                                                                                   │                      
          ╔══════╤════════╪═════════════════════════════════╪═╪════════════════════════════════════════════════════════════════════════════════╪═════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════╪═══════════════════════╪═══════════════════════════════════════════════════════════════════════════════════╪═════════════════════╗
          ║ ALT  │  result true                             │ │                                                                                │                                                                                                                         │                       │                                                                                   │                     ║
          ╟──────┘        │                                 │ │                                                                                │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │────┐                                                                           │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │    │ ConvertTaskItemToFsPath(TypeLibraryReferences, SupportHintPath=False)     │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │<───┘                                                                           │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │────┐                                                                           │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │    │ ConvertTaskItemToFsPath(TypeLibraryReferencePaths, SupportHintPath=False) │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │<───┘                                                                           │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │────┐                                                                           │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │    │ ConvertTaskItemToFsPath(AssemblyPaths, SupportHintPath=True)              │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │<───┘                                                                           │                             │                                                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                                                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                    set_TLBReference(conversionResult[TypeLibraryReferences])   │                 ┌────────────────────────┐                                                                              │                       │                                                                                   │                     ║
          ║               │                                 │ │ ────────────────────────────────────────────────────────────────────────────────────────────────>│TypeLibConverterSettings│                                                                              │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                 └───────────┬────────────┘                                                                              │                       │                                                                                   │                     ║
          ║               │                                 │ │                          set_TLBRefpath(conversionResult[TypeLibraryReferencePaths])                         │                                                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │ ─────────────────────────────────────────────────────────────────────────────────────────────────────────────>                                                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                                                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                 set_ASMPath(conversionResult[AssemblyPaths])   │                             │                                                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │ ─────────────────────────────────────────────────────────────────────────────────────────────────────────────>                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                           VerifyFilesPresent(Assembly, ReportAsError=True)                   │                       ┌────────────────┐                                                  │                       │                                                                                   │                     ║
          ║               │                                 │ │ ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│FileSystemChecks│                                                  │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                       └───────┬────────┘                                                  │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                  VerifyFilesPresent(files)                  │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │ <────────────────────────────────────────────────────────────                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                 VerifyFilesPresent(TypeLibraryReferences, AssemblyPaths, ReportAsError=False)│                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │ ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                  VerifyFilesPresent(files)                  │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │ <────────────────────────────────────────────────────────────                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                   VerifyDirectoriesPresent(TypeLibraryReferencePaths, ReportAsError=False)   │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │ ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │               VerifyDirectoriesPresent(files)               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │ <────────────────────────────────────────────────────────────                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                           ConvertAssemblyToTypeLib                            ┌┴┐                            │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │ ─────────────────────────────────────────────────────────────────────────────>│ │                            │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                               ╔══════╤════════╪═╪════════════════════════════╪═══════════════════════════════╪═══════════════════════════════════════════════════════════╪══════════════════╗    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ║ ALT  │  IsNet50OrLater                       │                               │                             │                             │                  ║    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ╟──────┘        │ │                            │                               │                             │                             │                  ║    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ║               │ │                   add_Resolving(ResolveAssemblyFromSettings)                   ┌───────────────────┐                   │                  ║    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ║               │ │ ──────────────────────────────────────────────────────────────────────────────>│AssemblyLoadContext│                   │                  ║    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ╠═══════════════╪═╪════════════════════════════╪═══════════════════════════════╪═══════════════════════════════════════════════════════════╪══════════════════╣    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ║ [IsNetFx]     │ │                            │                               │                             │                             │                  ║    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ║               │ │                            │       add_AssemblyResolve(ResolveAssemblyFromSettings)      │                             │                  ║    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ║               │ │ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                  ║    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ╚═══════════════╪═╪════════════════════════════╪═══════════════════════════════╪═════════════════════════════╪═════════════════════════════╪══════════════════╝    │                                                                                   │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                               │ │                            │                      Load(TypeLibExportSettings.SourceAssembly)                           │                       │  ╔═══════════════════════════╗                                                    │                     ║
          ║               │                                 │ │                                                                               │ │ ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>  ║Load Assemblies recursive ░║                                                    │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │  ╚═════════════════════════╤═╝                                                    │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │           set_Logger(log)   │                             │                       │               ┌──────────────────────────┐                                        │                     ║
          ║               │                                 │ │                                                                               │ │ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│LoggingTypeLibExporterSink│                  │                     │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │               └────────────┬─────────────┘                  │                     │                     ║
          ║               │                                 │ │                                                                               │ │                            │                          ConvertAssemblyToTypeLib(Assembly, TypeLibConverterSettings, LoggingTypeLibExporterSink) │                            │                        ┌────────────────┐            │                     ║
          ║               │                                 │ │                                                                               │ │ ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│TypeLibConverter│            │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │                            │                        └───────┬────────┘            │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │                                 │ │                                                               ╔══════╤════════╪═╪════════════════════════════╪═══════════════════════════════╪═════════════════════════════╪═════════════════════════════╪═══════════════════════╪════════════════════════════╪════════════════════════════════╪═════════════════════╪═══════════╗         ║
          ║               │                                 │ │                                                               ║ ALT  │  result is null                       │                               │                             │                             │                       │                            │                                │                     │           ║         ║
          ║               │                                 │ │                                                               ╟──────┘        │ │                            │                               │                             │                             │                       │                            │                                │                     │           ║         ║
          ║               │                                 │ │                                                               ║               │ │                            │                               │                             │                    Error    │                       │                            │                                │                     │           ║         ║
          ║               │                                 │ │                                                               ║               │ │ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│           ║         ║
          ║               │                                 │ │                                                               ╚═══════════════╪═╪════════════════════════════╪═══════════════════════════════╪═════════════════════════════╪═════════════════════════════╪═══════════════════════╪════════════════════════════╪════════════════════════════════╪═════════════════════╪═══════════╝         ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │                                 │ │                                                               ╔══════╤════════╪═╪════════════════════════════╪═══════════════════════════════╪═════════════════════════════╪═════════════════════════════╪═══════════════════════╪════════════════════════════╪════════════════════════════════╪═════════════════════╪═══════════╗         ║
          ║               │                                 │ │                                                               ║ ALT  │  TLB Not Existing                     │                               │                             │                             │                       │                            │                                │                     │           ║         ║
          ║               │                                 │ │                                                               ╟──────┘        │ │                            │                               │                             │                             │                       │                            │                                │                     │           ║         ║
          ║               │                                 │ │                                                               ║               │ │                            │                               │                             │              Warning(DSCOM001)                      │                            │                                │                     │           ║         ║
          ║               │                                 │ │                                                               ║               │ │ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│           ║         ║
          ║               │                                 │ │                                                               ╚═══════════════╪═╪════════════════════════════╪═══════════════════════════════╪═════════════════════════════╪═════════════════════════════╪═══════════════════════╪════════════════════════════╪════════════════════════════════╪═════════════════════╪═══════════╝         ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │                   ╔══════╤══════╪═╪═══════════════════════════════════════════════════════════════════════════════╪═╪════════════════════════════╪═══════════════════════════════╪════════════════════════════\╪/══════════════════╗         │                       │                            │                                │                     │                     ║
          ║               │                   ║ ALT  │  IsNet50OrLater                                                                        │ │                            │                               │                             X                   ║         │                       │                            │                                │                     │                     ║
          ║               │                   ╟──────┘      │ │                                                                               │ │                            │                               │                            /│\                  ║         │                       │                            │                                │                     │                     ║
          ║               │                   ║             │ │                                                                               │ │ Unload                     │                               │                             │                   ║         │                       │                            │                                │                     │                     ║
          ║               │                   ║             │ │ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                   ║         │                       │                            │                                │                     │                     ║
          ║               │                   ╚═════════════╪═╪═══════════════════════════════════════════════════════════════════════════════╪═╪════════════════════════════╪═══════════════════════════════╪═════════════════════════════╪═══════════════════╝         │                       │                            │                                │                     │                     ║
          ║               │                                 │ │                                                                               └┬┘                            │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │return result && Log.HasNoErrors │ │                                                                                │                             │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │<────────────────────────────────│ │                                                                                │                             │                               │                             │                             │                       │                            │                                │                     │                     ║
          ╠═══════════════╪═════════════════════════════════╪═╪════════════════════════════════════════════════════════════════════════════════╪═════════════════════════════╪═══════════════════════════════╪═════════════════════════════╪═════════════════════════════╪═══════════════════════╪════════════════════════════╪════════════════════════════════╪═════════════════════╪═════════════════════╣
          ║ [result false]│                                 │ │                                                                                │                             │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │                                 │ │                                                                                │                             │                               │         Error               │                             │                       │                            │                                │                     │                     ║
          ║               │                                 │ │ ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                     ║
          ║               │                                 └┬┘                                                                                │                             │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │              false               │                                                                                 │                             │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                                                                 │                             │                               │                             │                             │                       │                            │                                │                     │                     ║
          ╚═══════════════╪══════════════════════════════════╪═════════════════════════════════════════════════════════════════════════════════╪═════════════════════════════╪═══════════════════════════════╪═════════════════════════════╪═════════════════════════════╪═══════════════════════╪════════════════════════════╪════════════════════════════════╪═════════════════════╪═════════════════════╝
                    ┌─────┴─────┐                       ┌────┴────┐                                                                     ┌──────┴──────┐          ┌───────────┴────────────┐          ┌───────┴────────┐          ┌─────────┴─────────┐          ┌────────┴────────┐          ┌───┴────┐          ┌────────────┴─────────────┐          ┌───────┴────────┐          ┌─┴─┐                    
                    │BuildEngine│                       │TlbExport│                                                                     │IBuildContext│          │TypeLibConverterSettings│          │FileSystemChecks│          │AssemblyLoadContext│          │AppDomain.Current│          │Assembly│          │LoggingTypeLibExporterSink│          │TypeLibConverter│          │Log│                    
                    └───────────┘                       └─────────┘                                                                     └─────────────┘          └────────────────────────┘          └────────────────┘          └───────────────────┘          └─────────────────┘          └────────┘          └──────────────────────────┘          └────────────────┘          └───┘                    
```

## Test

### Unit tests

The class `TlbExport` is written with a level of abstraction and hence is tested with a [unit test](../../src/dscom.test/tests/BuildTaskTest.cs).

### Acceptance tests

The examples [32-bit](../../examples/32bit/) and [outproc](../../examples/outproc/) each provide an `msbuild-acceptance-test.cmd` script. This file builds and packages the build task and adds it to the `.csproj` file of the resulting assembly. Then the build is conducted. It must be warning free.

## Packaging

TODO

## Targets and Properties

TODO

## Limitations

TODO
