# dscom.build

## Project

Within the [source](../../src/) folder, a project called [dscom.build](../../src/dscom.build/) was created. It consumes the core tasks package of MsBuild and the dSPACE.Runtime.InteropServices assembly. The resulting assembly will be called `dSPACE.Runtime.InteropServices.Build`. This will also be the name of the NuGet package.

The Nug

The project consists of two notable classes.

### Class `TlbExport`

The class [`dSPACE.Runtime.InteropServices.Build.TlbExport`](../../src/dscom.build/TlbExport.cs) contains the implementation of the build task.

It consumes the following properties:

* `TlbOverriddenId`: The id of the type library. If it is set to the empty Guid, the Guid of the TypeLibrary will be used.
* `TargetFile` (Required): The full path to the type library to export.
* `SourceAssemblyFile` (Required): The full path of the managed assembly to export.
* `TypeLibraryReferences`: The input type libraries to reference during export.
* `TypeLibraryReferencePaths`: A list of paths containing type library files to reference automatically during export.
* `AssemblyPaths`: The references of the source assembly which must be loaded for export.

It contains the method `bool Execute()` as an implementation of the `ITask` interface.

The execute method will load the `dSPACE.Runtime.InteropServices.dll`. It tries to locate the file next to the build task assembly and - if cannot be present at that time - let the .NET runtime try to resolve it.

During the execution phase, the following steps will be made:

* Parse the overridden type library Guid.
* Fail execution, if the build is not executed on windows.
* Convert the `ITaskItems` (cf. `TypeLibraryReferences`, `TypeLibraryReferencePaths`, `AssemblyPaths`) to file system identifiers. If a file or directory is not present, a warning will be issued using the MsBuild `TaskLoggingHelper`. The export will continue.
* Resolve the `SourceAssemblyFile` and issue an error, if it was not found.
* Convert the assembly using the `DefaultBuildContext`.

The `DefaultBuildContext` represents a level of abstraction. It contains the part of the implementation that cannot be stubbed or mocked at run-time.

The execution will be successful, if the build context returns success and the task logging helper did not log any errors.

### Class `DefaultBuildContext`

The `DefaultBuildContext` is an implementation of the [`IBuildContext`](../../src/dscom.build/IBuildContext.cs) interface. It provides the following operations:

* Check, whether the build is running on windows.
* Check, whether given files and directories exist.
* Perform the export using the `TypeLibConverterSettings`.

The export is done using the `TypeLibConverter` instance and an implementation of the [`ITypeLibExporterNotifySink`](../../src/dscom.build/LoggingTypeLibExporterSink.cs), which logs the events to the build log.

If the type library converter did not report a successful export, an error will be issued. If the expected file did not exists after the export, a warning shall be issued.

It is an issue for discussion, if this check can be added to the `TlbExport` implementation. This way, the warning can be unit tested.

### Build sequence (TlbExport)

```ditaa
                    ┌───────────┐                       ┌─────────┐                                                                     ┌─────────────┐                                                                                                         ┌─────────────────┐          ┌────────┐                                                                            ┌───┐                    
                    │BuildEngine│                       │TlbExport│                                                                     │IBuildContext│                                                                                                         │AppDomain.Current│          │Assembly│                                                                            │Log│                    
                    └─────┬─────┘                       └────┬────┘                                                                     └──────┬──────┘                                                                                                         └────────┬────────┘          └───┬────┘                                                                            └─┬─┘                    
                          │            Execute              ┌┴┐                                                                                │                                                                                                                         │                       │                                                                                   │                      
                          │────────────────────────────────>│ │                                                                                │                                                                                                                         │                       │                                                                                   │                      
                          │                                 │ │                                                                                │                                                                                                                         │                       │                                                                                   │                      
                          │                                 │ │                              IsRunningOnWindows()                              │                                                                                                                         │                       │                                                                                   │                      
                          │                                 │ │ ──────────────────────────────────────────────────────────────────────────────>│                                                                                                                         │                       │                                                                                   │                      
                          │                                 │ │                                                                                │                                                                                                                         │                       │                                                                                   │                      
                          │                                 │ │                                                                                │                                                                                                                         │                       │                                                                                   │                      
          ╔══════╤════════╪═════════════════════════════════╪═╪════════════════════════════════════════════════════════════════════════════════╪═════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════╪═══════════════════════╪═══════════════════════════════════════════════════════════════════════════════════╪═════════════════════╗
          ║ ALT  │  result true                             │ │                                                                                │                                                                                                                         │                       │                                                                                   │                     ║
          ╟──────┘        │                                 │ │                                                                                │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │────┐                                                                           │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │    │ ConvertTaskItemToFsPath(TypeLibraryReferences, SupportHintPath=False)     │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │<───┘                                                                           │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │────┐                                                                           │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │    │ ConvertTaskItemToFsPath(TypeLibraryReferencePaths, SupportHintPath=False) │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │<───┘                                                                           │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │────┐                                                                           │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │    │ ConvertTaskItemToFsPath(AssemblyPaths, SupportHintPath=True)              │                                                                                                                         │                       │                                                                                   │                     ║
          ║               │                                 │ │<───┘                                                                           │                             │                                                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                                                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                    set_TLBReference(conversionResult[TypeLibraryReferences])   │                 ┌────────────────────────┐                                                                              │                       │                                                                                   │                     ║
          ║               │                                 │ │ ────────────────────────────────────────────────────────────────────────────────────────────────>│TypeLibConverterSettings│                                                                              │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                 └───────────┬────────────┘                                                                              │                       │                                                                                   │                     ║
          ║               │                                 │ │                          set_TLBRefpath(conversionResult[TypeLibraryReferencePaths])                         │                                                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │ ─────────────────────────────────────────────────────────────────────────────────────────────────────────────>                                                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                                                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                 set_ASMPath(conversionResult[AssemblyPaths])   │                             │                                                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │ ─────────────────────────────────────────────────────────────────────────────────────────────────────────────>                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                           VerifyFilesPresent(Assembly, ReportAsError=True)                   │                       ┌────────────────┐                                                  │                       │                                                                                   │                     ║
          ║               │                                 │ │ ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│FileSystemChecks│                                                  │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                       └───────┬────────┘                                                  │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                  VerifyFilesPresent(files)                  │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │ <────────────────────────────────────────────────────────────                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                 VerifyFilesPresent(TypeLibraryReferences, AssemblyPaths, ReportAsError=False)│                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │ ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                  VerifyFilesPresent(files)                  │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │ <────────────────────────────────────────────────────────────                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                   VerifyDirectoriesPresent(TypeLibraryReferencePaths, ReportAsError=False)   │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │ ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │               VerifyDirectoriesPresent(files)               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │ <────────────────────────────────────────────────────────────                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                                │                             │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                           ConvertAssemblyToTypeLib                            ┌┴┐                            │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │ ─────────────────────────────────────────────────────────────────────────────>│ │                            │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                                                           │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                               ╔══════╤════════╪═╪════════════════════════════╪═══════════════════════════════╪═══════════════════════════════════════════════════════════╪══════════════════╗    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ║ ALT  │  IsNet50OrLater                       │                               │                             │                             │                  ║    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ╟──────┘        │ │                            │                               │                             │                             │                  ║    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ║               │ │                   add_Resolving(ResolveAssemblyFromSettings)                   ┌───────────────────┐                   │                  ║    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ║               │ │ ──────────────────────────────────────────────────────────────────────────────>│AssemblyLoadContext│                   │                  ║    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ╠═══════════════╪═╪════════════════════════════╪═══════════════════════════════╪═══════════════════════════════════════════════════════════╪══════════════════╣    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ║ [IsNetFx]     │ │                            │                               │                             │                             │                  ║    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ║               │ │                            │       add_AssemblyResolve(ResolveAssemblyFromSettings)      │                             │                  ║    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ║               │ │ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                  ║    │                                                                                   │                     ║
          ║               │                                 │ │                                                               ╚═══════════════╪═╪════════════════════════════╪═══════════════════════════════╪═════════════════════════════╪═════════════════════════════╪══════════════════╝    │                                                                                   │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │                                                                                   │                     ║
          ║               │                                 │ │                                                                               │ │                            │                      Load(TypeLibExportSettings.SourceAssembly)                           │                       │  ╔═══════════════════════════╗                                                    │                     ║
          ║               │                                 │ │                                                                               │ │ ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>  ║Load Assemblies recursive ░║                                                    │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │  ╚═════════════════════════╤═╝                                                    │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │           set_Logger(log)   │                             │                       │               ┌──────────────────────────┐                                        │                     ║
          ║               │                                 │ │                                                                               │ │ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│LoggingTypeLibExporterSink│                  │                     │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │               └────────────┬─────────────┘                  │                     │                     ║
          ║               │                                 │ │                                                                               │ │                            │                          ConvertAssemblyToTypeLib(Assembly, TypeLibConverterSettings, LoggingTypeLibExporterSink) │                            │                        ┌────────────────┐            │                     ║
          ║               │                                 │ │                                                                               │ │ ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│TypeLibConverter│            │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │                            │                        └───────┬────────┘            │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │                                 │ │                                                               ╔══════╤════════╪═╪════════════════════════════╪═══════════════════════════════╪═════════════════════════════╪═════════════════════════════╪═══════════════════════╪════════════════════════════╪════════════════════════════════╪═════════════════════╪═══════════╗         ║
          ║               │                                 │ │                                                               ║ ALT  │  result is null                       │                               │                             │                             │                       │                            │                                │                     │           ║         ║
          ║               │                                 │ │                                                               ╟──────┘        │ │                            │                               │                             │                             │                       │                            │                                │                     │           ║         ║
          ║               │                                 │ │                                                               ║               │ │                            │                               │                             │                    Error    │                       │                            │                                │                     │           ║         ║
          ║               │                                 │ │                                                               ║               │ │ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│           ║         ║
          ║               │                                 │ │                                                               ╚═══════════════╪═╪════════════════════════════╪═══════════════════════════════╪═════════════════════════════╪═════════════════════════════╪═══════════════════════╪════════════════════════════╪════════════════════════════════╪═════════════════════╪═══════════╝         ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │                                 │ │                                                               ╔══════╤════════╪═╪════════════════════════════╪═══════════════════════════════╪═════════════════════════════╪═════════════════════════════╪═══════════════════════╪════════════════════════════╪════════════════════════════════╪═════════════════════╪═══════════╗         ║
          ║               │                                 │ │                                                               ║ ALT  │  TLB Not Existing                     │                               │                             │                             │                       │                            │                                │                     │           ║         ║
          ║               │                                 │ │                                                               ╟──────┘        │ │                            │                               │                             │                             │                       │                            │                                │                     │           ║         ║
          ║               │                                 │ │                                                               ║               │ │                            │                               │                             │              Warning(DSCOM001)                      │                            │                                │                     │           ║         ║
          ║               │                                 │ │                                                               ║               │ │ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│           ║         ║
          ║               │                                 │ │                                                               ╚═══════════════╪═╪════════════════════════════╪═══════════════════════════════╪═════════════════════════════╪═════════════════════════════╪═══════════════════════╪════════════════════════════╪════════════════════════════════╪═════════════════════╪═══════════╝         ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │                                 │ │                                                                               │ │                            │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │                   ╔══════╤══════╪═╪═══════════════════════════════════════════════════════════════════════════════╪═╪════════════════════════════╪═══════════════════════════════╪════════════════════════════\╪/══════════════════╗         │                       │                            │                                │                     │                     ║
          ║               │                   ║ ALT  │  IsNet50OrLater                                                                        │ │                            │                               │                             X                   ║         │                       │                            │                                │                     │                     ║
          ║               │                   ╟──────┘      │ │                                                                               │ │                            │                               │                            /│\                  ║         │                       │                            │                                │                     │                     ║
          ║               │                   ║             │ │                                                                               │ │ Unload                     │                               │                             │                   ║         │                       │                            │                                │                     │                     ║
          ║               │                   ║             │ │ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                   ║         │                       │                            │                                │                     │                     ║
          ║               │                   ╚═════════════╪═╪═══════════════════════════════════════════════════════════════════════════════╪═╪════════════════════════════╪═══════════════════════════════╪═════════════════════════════╪═══════════════════╝         │                       │                            │                                │                     │                     ║
          ║               │                                 │ │                                                                               └┬┘                            │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │return result && Log.HasNoErrors │ │                                                                                │                             │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │<────────────────────────────────│ │                                                                                │                             │                               │                             │                             │                       │                            │                                │                     │                     ║
          ╠═══════════════╪═════════════════════════════════╪═╪════════════════════════════════════════════════════════════════════════════════╪═════════════════════════════╪═══════════════════════════════╪═════════════════════════════╪═════════════════════════════╪═══════════════════════╪════════════════════════════╪════════════════════════════════╪═════════════════════╪═════════════════════╣
          ║ [result false]│                                 │ │                                                                                │                             │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │                                 │ │                                                                                │                             │                               │         Error               │                             │                       │                            │                                │                     │                     ║
          ║               │                                 │ │ ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                     ║
          ║               │                                 └┬┘                                                                                │                             │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │              false               │                                                                                 │                             │                               │                             │                             │                       │                            │                                │                     │                     ║
          ║               │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                                                                                 │                             │                               │                             │                             │                       │                            │                                │                     │                     ║
          ╚═══════════════╪══════════════════════════════════╪═════════════════════════════════════════════════════════════════════════════════╪═════════════════════════════╪═══════════════════════════════╪═════════════════════════════╪═════════════════════════════╪═══════════════════════╪════════════════════════════╪════════════════════════════════╪═════════════════════╪═════════════════════╝
                    ┌─────┴─────┐                       ┌────┴────┐                                                                     ┌──────┴──────┐          ┌───────────┴────────────┐          ┌───────┴────────┐          ┌─────────┴─────────┐          ┌────────┴────────┐          ┌───┴────┐          ┌────────────┴─────────────┐          ┌───────┴────────┐          ┌─┴─┐                    
                    │BuildEngine│                       │TlbExport│                                                                     │IBuildContext│          │TypeLibConverterSettings│          │FileSystemChecks│          │AssemblyLoadContext│          │AppDomain.Current│          │Assembly│          │LoggingTypeLibExporterSink│          │TypeLibConverter│          │Log│                    
                    └───────────┘                       └─────────┘                                                                     └─────────────┘          └────────────────────────┘          └────────────────┘          └───────────────────┘          └─────────────────┘          └────────┘          └──────────────────────────┘          └────────────────┘          └───┘                    
```

## Test

### Unit tests

The class `TlbExport` is written with a level of abstraction and hence is tested with a [unit test](../../src/dscom.test/tests/BuildTaskTest.cs).

### Acceptance tests

The examples [32-bit](../../examples/32bit/) and [outproc](../../examples/outproc/) each provide an `msbuild-acceptance-test.cmd` script. This file builds and packages the build task and adds it to the `.csproj` file of the resulting assembly. Then the build is conducted. It must be warning free.

## Packaging

The packaging will contain the executable file for [dscom CLI](../../src/dscom.client/dscom.client.csproj) for both platforms, x64 and x86. The configuration is Release. The executable will be published in Release as a framework dependent deployment using a [single file](https://learn.microsoft.com/en-us/dotnet/core/deploying/single-file/overview?tabs=cli), which means that [dSPACE.Runtime.InteropServices](../../src/dscom/dscom.csproj) and [System.CommandLine](https://packages.nuget.org/packages/System.CommandLine/) are bundled, but no AOT takes place and no framework files will be part of the bundle.

The packaging takes place in [DsComPackaging.targets](../../src/dscom.build/DsComPackaging.targets) which is imported by [dscom.build.csproj](../../src/dscom.build/dscom.build.csproj). The targets file hooks into the packaging procedure by enforcing to be run before the `GenerateNuspec` target of the NuGet Client which is part of the packaging process by the MsBuild dotnet sdk in the [NuGet.Build.Tasks.Pack.targets](https://github.com/NuGet/NuGet.Client/blob/dev/src/NuGet.Core/NuGet.Build.Tasks.Pack/NuGet.Build.Tasks.Pack.targets) and exposes the `GenerateNuspecDependsOn` array variable. Two targets must be executed before generating the NuSpec file:

**DsComBuildPackTaskDependencies**:
    This task packs the [dSPACE.Runtime.InteropServices](../../src/dscom/dscom.csproj) and [System.CommandLine](https://packages.nuget.org/packages/System.CommandLine/) assembly into the package. This will enable the [TlbExport](../../src/dscom.build/TlbExport.cs) task to load the assembly. Due to a [bug in MsBuild](https://github.com/dotnet/msbuild/issues/1755) and another [issue with NuGet](https://github.com/NuGet/Home/issues/4704), MsBuild does not add assemblies from dependent package to the resolve handler. Hence the dependent assembly must be bundled with the NuGet package. Refer to a [blog article](https://natemcmaster.com/blog/2017/11/11/msbuild-task-with-dependencies/) for details.

**DsComBuildPackTool**:
    The MsBuild process is hosted using the target framework, i.e. .NET FullFramework 4.8 or .NET 6.0 using an x64 based process environment. In order to enable the build using the 32bit builder and other target frameworks, the executables will be added to the NuGet package. This approach has been inspired by [Grpc.Tools](https://github.com/grpc/grpc/blob/master/src/csharp/Grpc.Tools/build/native/Grpc.Tools.props) NuGet package which bundles the `protoc.exe` and `grpc_cpp_plugin.exe` executables.
    In order to get the matching binaries without interfering with the regular MsBuild and NuGet packaging, the task calls the [MsBuild](https://learn.microsoft.com/en-us/visualstudio/msbuild/msbuild-task) task for the [dscom.client.csproj](../../src/dscom.client/dscom.client.csproj) using the targets `Restore`, `Build` and `Pack` targets for both platforms, x86 and x64 using a different output directory.

## Targets and Properties

The package containing the build task comes with [props and targets for MsBuild](https://learn.microsoft.com/en-us/nuget/concepts/msbuild-props-and-targets). These files are automatically included to the build using the naming convention. There is also a folder for .NET Standard 2.0 which will only include the general files.

**[dSPACE.Runtime.InteropServices.BuildTasks.props](../../src/dscom.build/dSPACE.Runtime.InteropServices.BuildTasks.props)**:
  This property file contains the general properties for the integration of the build task.

**[dSPACE.Runtime.InteropServices.BuildTasks.targets](../../src/dscom.build/dSPACE.Runtime.InteropServices.BuildTasks.targets)**:
  This target file includes the general tasks and targets. It will also create the properties and item groups based on the data provided by the project being build. Depending on the enforced usage of the tools or task, it will include the tool or task specific targets fill.

**[dSPACE.Runtime.InteropServices.BuildTasks.Task.targets](../../src/dscom.build/dSPACE.Runtime.InteropServices.BuildTasks.Task.targets)**:
  This target file includes the targets and tasks which invoke the TLB export as MsBuild task.

**[dSPACE.Runtime.InteropServices.BuildTasks.Tools.targets](../../src/dscom.build/dSPACE.Runtime.InteropServices.BuildTasks.Tools.targets)**:
  This target file includes the targets and tasks which invoke the TLB export a call to the bundled executables.

The general approach is designed by the MsBuild SDK based projects. The props file will be included in the beginning of the project file _automatically_, i.e. before the project file is read. The targets file will be in included at the end of the project file _automatically_, i.e. after the project file has been read. Hence project specific settings are only available in the targets file.

## Limitations

### InProc Export

The [LibraryWriter](../../src/dscom/writer/LibraryWriter.cs) currently refuses to write the type library file (TLB), if the file is hosted within the MsBuild Process. The reason is currently unknown. Therefore it is not recommended to set `_DsComForceToolUsage` to `false`.

### .NET Standard 2.0 compliant NuGet package

The `Pack` target currently does not create a .NET Standard 2.0 compliant NuGet package. Therefore, when adding the `dSPACE.Runtime.InteropServices.Build` package to a .NET Standard 2.0 targeting project, the warning [NU1701](https://learn.microsoft.com/en-us/nuget/reference/errors-and-warnings/nu1701) will be issued. This warning can be explicitly disabled for the package using the package meta data:

```xml
<ItemGroup>
  ...
  <PackageReference Include="dspace.runtime.interopservices.build" Version="..." NoWarn="NU1701" />
  ...
</ItemGroup>
```
